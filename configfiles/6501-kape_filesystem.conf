# SOF-ELKÂ® Configuration File
# Author: Phil Hagen
# Email: phil@lewestech.com
#
# (C)2019 Lewes Technology Consulting, LLC
#
# This conf file accepts logs from the KAPE forensic tool

filter {
  if [type] == "kape_filesystem" and "json" not in [tags] {
    mutate {
      # create two "timestamp" fields with the MACBs in subfields
      rename => {
        "[raw][LastRecordChange0x10]" => "[STDINFO][LastRecordChange]"
        "[raw][LastModified0x10]" => "[STDINFO][LastModified]"
        "[raw][LastAccess0x10]" => "[STDINFO][LastAccess]"
        "[raw][Created0x10]" => "[STDINFO][Created]"

        "[raw][LastRecordChange0x30]" => "[FILENAME][LastRecordChange]"
        "[raw][LastModified0x30]" => "[FILENAME][LastModified]"
        "[raw][LastAccess0x30]" => "[FILENAME][LastAccess]"
        "[raw][Created0x30]" => "[FILENAME][Created]"
      }
    }

    # strip timestamps to just their integers
    mutate {
      gsub => [ "[STDINFO][LastRecordChange]", "\/Date\((\d+)\)\/", "\1" ]
      gsub => [ "[STDINFO][LastModified]", "\/Date\((\d+)\)\/", "\1" ]
      gsub => [ "[STDINFO][LastAccess]", "\/Date\((\d+)\)\/", "\1" ]
      gsub => [ "[STDINFO][Created]", "\/Date\((\d+)\)\/", "\1" ]

      gsub => [ "[FILENAME][LastRecordChange]", "\/Date\((\d+)\)\/", "\1" ]
      gsub => [ "[FILENAME][LastModified]", "\/Date\((\d+)\)\/", "\1" ]
      gsub => [ "[FILENAME][LastAccess]", "\/Date\((\d+)\)\/", "\1" ]
      gsub => [ "[FILENAME][Created]", "\/Date\((\d+)\)\/", "\1" ]
    }

    # use the STDINFO LastModified time for @timestamp
    date {
      match => [ "[STDINFO][LastModified]", "UNIX_MS" ]
    }

    # convert all STDINFO timestamps to date/time types
    date {
      match => [ "[STDINFO][LastRecordChange]", "UNIX_MS" ]
      target => "[STDINFO][LastRecordChange]"
    }
    date {
      match => [ "[STDINFO][LastModified]", "UNIX_MS" ]
      target => "[STDINFO][LastModified]"
    }
    date {
      match => [ "[STDINFO][LastAccess]", "UNIX_MS" ]
      target => "[STDINFO][LastAccess]"
    }
    date {
      match => [ "[STDINFO][Created]", "UNIX_MS" ]
      target => "[STDINFO][Created]"
    }

    # convert all FILENAME timestamps to date/time types
    date {
      match => [ "[FILENAME][LastRecordChange]", "UNIX_MS" ]
      target => "[FILENAME][LastRecordChange]"
    }
    date {
      match => [ "[FILENAME][LastModified]", "UNIX_MS" ]
      target => "[FILENAME][LastModified]"
    }
    date {
      match => [ "[FILENAME][LastAccess]", "UNIX_MS" ]
      target => "[FILENAME][LastAccess]"
    }
    date {
      match => [ "[FILENAME][Created]", "UNIX_MS" ]
      target => "[FILENAME][Created]"
    }

    # convert SiFlags to true/false array
    mutate {
      rename => {
        "[raw][SiFlags]" => "SiFlags"
      }
    }
    ruby {
      path => "/usr/local/sof-elk/supporting-scripts/ntfs_flags_to_array.rb"
      script_params => { "source_field" => "SiFlags" }
    }

    # Create KAPE-specific flag array
    mutate {
      rename => {
        "[raw][InUse]" => "[KAPEFileInfo][InUse]"
        "[raw][IsDirectory]" => "[KAPEFileInfo][IsDirectory]"
        "[raw][HasAds]" => "[KAPEFileInfo][HasAds]"
        "[raw][IsAds]" => "[KAPEFileInfo][IsAds]"
        "[raw][Timestomped]" => "[KAPEFileInfo][Timestomped]"
        "[raw][Copied]" => "[KAPEFileInfo][Copied]"
      }
    }

    # clean up by promoting needed fields to keep and removing [raw] placeholder
    mutate {
      rename => {
        "[raw][EntryNumber]" => "EntryNumber"
        "[raw][SequenceNumber]" => "SequenceNumber"
        "[raw][ParentEntryNumber]" => "ParentEntryNumber"
        "[raw][ParentSequenceNumber]" => "ParentSequenceNumber"
        "[raw][ParentPath]" => "ParentPath"
        "[raw][FileName]" => "FileName"
        "[raw][Extension]" => "Extension"
        "[raw][FileSize]" => "FileSize"
        "[raw][ReferenceCount]" => "ReferenceCount"
        "[raw][ReparseTarget]" => "ReparseTarget"
        "[raw][NameType]" => "NameType"
        "[raw][UpdateSequenceNumber]" => "UpdateSequenceNumber"
        "[raw][LogfileSequenceNumber]" => "LogfileSequenceNumber"
        "[raw][SecurityId]" => "SecurityId"
        "[raw][ObjectIdFileDroid]" => "ObjectIdFileDroid"
        "[raw][LoggedUtilStream]" => "LoggedUtilStream"
        "[raw][ZoneIdContents]" => "ZoneIdContents"
      }
      remove_field => [ "raw" ]
    }
  }
}
