# SOF-ELKÂ® Configuration File
# Author: Phil Hagen
# Email: phil@lewestech.com
#
# (C)2019 Lewes Technology Consulting, LLC
#
# This conf file accepts logs from the KAPE forensic tool

filter {
  if [type] == "kape_lnkfiles" and "json" not in [tags] {
    mutate {
      # create "source" and "target" superfields
      # promote necessary fields from the [raw] placeholder
      # remove the [raw] placeholder
      rename => {
        "[raw][SourceCreated]" => "[Source][Created]"
        "[raw][SourceModified]" => "[Source][Modified]"
        "[raw][SourceAccessed]" => "[Source][Accessed]"

        "[raw][TargetCreated]" => "[Target][Created]"
        "[raw][TargetModified]" => "[Target][Modified]"
        "[raw][TargetAccessed]" => "[Target][Accessed]"

        "[raw][SourceFile]" => "[Source][FileName]"
        "[raw][MachineMACAddress]" => "[Source][MachineMACAddress]"
        "[raw][MACVendor]" => "[Source][MACVendor]"
        "[raw][TrackerCreatedOn]" => "[Source][TrackerCreatedOn]"

        "[raw][FileSize]" => "[Target][FileSize]"
        "[raw][Arguments]" => "[Target][Arguments]"
        "[raw][WorkingDirectory]" => "[Target][WorkingDirectory]"
        "[raw][DriveType]" => "[Target][DriveType]"
        "[raw][VolumeSerialNumber]" => "[Target][VolumeSerialNumber]"
        "[raw][VolumeLabel]" => "[Target][VolumeLabel]"
        "[raw][LocalPath]" => "[Target][LocalPath]"
        "[raw][TargetIDAbsolutePath]" => "[Target][AbsolutePath]"
        "[raw][TargetMFTEntryNumber]" => "[Target][MFTEntryNumber]"
        "[raw][TargetMFTSequenceNumber]" => "[Target][MFTSequenceNumber]"
        "[raw][MachineID]" => "[Target][MachineID]"
        "[raw][RelativePath]" => "[Target][RelativePath]"
      }
      remove_field => [ "raw" ]
    }

    # clean up known potentially empty fields
    if [Target][Created] == "" {
      mutate {
        remove_field => [ "[Target][Created]" ]
      }
    }
    if [Target][Modified] == "" {
      mutate {
        remove_field => [ "[Target][Modified]" ]
      }
    }
    if [Target][Accessed] == "" {
      mutate {
        remove_field => [ "[Target][Accessed]" ]
      }
    }

    # use the source last modified time for @timestamp
    date {
      match => [ "[Source][Modified]", "ISO8601" ]
    }

    # convert all timestamps to date/time types
    date {
      match => [ "[Source][Created]", "ISO8601" ]
      target => "[Source][Created]"
    }
    date {
      match => [ "[Source][Modified]", "ISO8601" ]
      target => "[Source][Modified]"
    }
    date {
      match => [ "[Source][Accessed]", "ISO8601" ]
      target => "[Source][Accessed]"
    }
    date {
      match => [ "[Source][TrackerCreatedOn]", "ISO8601" ]
      target => "[Source][TrackerCreatedOn]"
    }
    date {
      match => [ "[Target][Created]", "ISO8601" ]
      target => "[Target][Created]"
    }
    date {
      match => [ "[Target][Modified]", "ISO8601" ]
      target => "[Target][Modified]"
    }
    date {
      match => [ "[Target][Accessed]", "ISO8601" ]
      target => "[Target][Accessed]"
    }
  }
}