# SOF-ELKÂ® Configuration File
# Author: Phil Hagen
# Email: phil@lewestech.com
#
# (C)2019 Lewes Technology Consulting, LLC
#
# This conf file accepts logs from the KAPE forensic tool

filter {
  if [type] == "kape_evtxlogs" and "json" not in [tags] {
    mutate {
      # promote the fields of interest out of the [raw] placeholder
      # remove the [raw] placeholder

      rename => {
        "[raw][Computer]" => "Computer"
        "[raw][RemoteHost]" => "RemoteHost"
        "[raw][UserId]" => "UserId"
        "[raw][UserName]" => "UserName"
        "[raw][Channel]" => "Channel"
        "[raw][Provider]" => "Provider"
        "[raw][EventId]" => "EventId"
        "[raw][EventRecordId]" => "EventRecordId"
        "[raw][ProcessId]" => "ProcessId"
        "[raw][ThreadId]" => "ThreadId"
        "[raw][Level]" => "Level"
        "[raw][SourceFile]" => "SourceFile"
        "[raw][TimeCreated]" => "TimeCreated"
        "[raw][RecordNumber]" => "RecordNumber"
        "[raw][Payload]" => "Payload"
        "[raw][MapDescription]" => "MapDescription"
        "[raw][ExecutableInfo]" => "ExecutableInfo"
        "[raw][PayloadData1]" => "PayloadData1"
        "[raw][PayloadData2]" => "PayloadData2"
        "[raw][PayloadData3]" => "PayloadData3"
        "[raw][PayloadData4]" => "PayloadData4"
        "[raw][PayloadData5]" => "PayloadData5"
        "[raw][PayloadData6]" => "PayloadData6"
      }
      remove_field => [ "raw" ]
    }

    # use the TimeCreated field for the timestamp
    date {
      match => [ "[TimeCreated]", "ISO8601" ]
    }

    # clean up field names for the Payload string
    mutate {
      gsub => [
        "RawPayloadString", "@Name", "Name",
        "RawPayloadString", "#text", "text"
      ]
    }

    # PJH: realistically, we need a better way to handle the Payload field, which is a bunch of json
    #      and possibly the PayloadData[1-6] fields.  This is a starting point, though.... It's going
    #      to be a challenge because of the widely varied content in those fields. Keeping as a string
    #      for the time being.
    #      It will probably need a somewhat complex ruby filter script.
  }
}